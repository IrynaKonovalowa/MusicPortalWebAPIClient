<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Music portal</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/site.css" asp-append-version="true" />
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.2.0.min.js"></script>
</head>
<body style="background-color: #050a5f">
    <div style="margin-bottom: 30px;">
        <div class="gif"></div>
        <div style="margin-left: 950px; height: 75px;" class="MusPortal"><a id="btn-home">Music portal</a></div>
    </div>

    <div style="display: flex; margin-left: 1200px;">
        <div class="but">
            <a style="color: whitesmoke" id="btn-genres">Genres</a>
        </div>
        <div class="but">
            <a style="color: whitesmoke" id="btn-users">Users</a>
        </div>
    </div>
    
    <div id="div-songs">
        <div>
            <a class="animated-button1" id="btn-create-song" style="color: whitesmoke">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                Add song
            </a>
        </div>
        <div>
            <div class="col-md-4">
                <form id="form-create-song" style="display:none;">
                    <input type="hidden" name="Id" value="0" />
                    <div class="form-group">
                        <label for="title" class="control-label labl">Title</label>
                        <input class="form-control" name="title" />
                        <span id="spanTitle" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label for="genre" class="control-label labl">Genre</label>
                        <select id="genreSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="singer" class="control-label labl">Singer</label>
                        <input class="form-control" name="singer" />
                        <span id="spanSinger" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label for="user" class="control-label labl">User</label>
                        <select id="userSelect" class="form-control"></select>
                    </div>
                    <div style=" display:flex">
                        <div class="but">
                            <a id="submit" style="color: whitesmoke">Save</a>

                        </div>
                        <div class="but">
                            <a id="reset" style="color: whitesmoke">Reset</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <br />
        <br />        
        <div class="name">Songs:</div>
        <table id="table-songs" class="table">
            <thead>
                <tr>                    
                    <th>Title</th>
                    <th>Singer</th>
                    <th>Genre</th>
                    <th>User</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="div-genres" style="display:none;">
        <div>
            <a class="animated-button1" id="btn-create-genre" style="color: whitesmoke">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                Add genre
            </a>
        </div>        
            <div class="col-md-4">
                <form id="form-create-genre" style="display:none;">
                    <input type="hidden" name="Id" value="0" />
                    <div class="form-group">
                        <label for="name" class="control-label labl">Name</label>
                        <input class="form-control" name="name" />
                        <span id="spanGenre" class="text-danger"></span>
                    </div>
                    <div style=" display:flex">
                        <div class="but">
                            <a id="submitGenre" style="color: whitesmoke">Save</a>
                        </div>
                        <div class="but">
                            <a id="resetGenre" style="color: whitesmoke">Reset</a>
                        </div>
                    </div>
                </form>
            </div>        
        <br />
        <br />
        <div class="name">Genres:</div>
        <table id="table-genres" class="table tableG_S">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="div-users" style="display:none;">
        <div>
            <a class="animated-button1" id="btn-create-user" style="color: whitesmoke">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                Add user
            </a>
        </div>
        <div class="col-md-4">
            <form id="form-create-user" style="display:none;">
                <input type="hidden" name="Id" value="0" />
                <div class="form-group">
                    <label for="firstName" class="control-label labl">FirstName</label>
                    <input class="form-control" name="firstName" />
                    <span id="spanUserFname" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="lastName" class="control-label labl">LastName</label>
                    <input class="form-control" name="lastName" />
                    <span id="spanUserLname" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="login" class="control-label labl">Login</label>
                    <input class="form-control" name="login" />
                    <span id="spanLogin" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="email" class="control-label labl">Email</label>
                    <input type="email" class="form-control" name="email" />
                    <span id="spanEmail" class="text-danger"></span>
                </div>
                <div style=" display:flex">
                    <div class="but">
                        <a id="submitUser" style="color: whitesmoke">Save</a>
                    </div>
                    <div class="but">
                        <a id="resetUser" style="color: whitesmoke">Reset</a>
                    </div>
                </div>
            </form>
        </div>
        <br />
        <br />        
        <div class="name">Users:</div>
        <table id="table-users" class="table">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>FirstName</th>
                    <th>LastName</th>
                    <th>Login</th>
                    <th>Email</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        $("#btn-home").on("click", function () {
            let divGenres = document.getElementById("div-genres");
            let divSongs = document.getElementById("div-songs");
            let divUsers = document.getElementById("div-users");
            if (divSongs.style.display !== "block") {
                divSongs.style.display = "block";
                divGenres.style.display = "none";
                divUsers.style.display = "none";
            }            
        });
        GetSongs();

        // Получение всех песен
        function GetSongs() {
            $.ajax({
                url: 'https://localhost:7193/api/Songs',
                method: "GET",
                contentType: "application/json",
                success: function (songs) {

                    let rows = "";
                    $.each(songs, function (index, song) {
                        // добавляем полученные элементы в таблицу
                        rows += row(song);
                    })
                    $("#table-songs tbody").append(rows);
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }
        // создание строки для таблицы
        let row = function (song) {
            return /*"<tr data-rowid='" + song.id + "'><td>" + song.id */ "<tr>" + "</td>" +
                "<td>" + song.title + "</td> <td>" + song.singer + "</td>" +
                "<td>" + song.genre + "</td> <td>" + song.user + "</td>" +
                "<td><a class='editLink' data-id='" + song.id + "'>Edit</a> | " +
                "<a class='removeLink' data-id='" + song.id + "'>Remove</a></td></tr>";
        };
        $("#btn-create-song").on("click", function () {
            let formSong = document.getElementById("form-create-song");
            if (formSong.style.display !== "block")
                formSong.style.display = "block";
            else
                formSong.style.display = "none";  
        });

        // function for Select genre
        $(function () {
            $.ajax({
                url: 'https://localhost:7193/api/Genres',
                method: "GET",
                contentType: "application/json",
                success: function (genres) {                    
                    let options = "";
                    $.each(genres, function (index, genre) {
                        // добавляем полученные элементы в Select
                        options += option(genre);
                    }) 
                    $("#genreSelect").append(options);
                    }         
                }); 
        }); 

        let option = function (genre) {
            return "<option>" + genre.name + "</option>";
        };
        // function for Select User
        $(function () {
            $.ajax({
                url: 'https://localhost:7193/api/Users',
                method: "GET",
                contentType: "application/json",
                success: function (users) {
                    let options = "";
                    $.each(users, function (index, user) {
                        // добавляем полученные элементы в Select
                        options += option1(user);
                    })
                    $("#userSelect").append(options);                    
                }
            });
        }); 
        let option1 = function (user) {
            return "<option>" + user.login + "</option>";
        };

        $("#submit").click(function (e) {
            e.preventDefault();
            let form = document.forms["form-create-song"];
            let id = form.elements["Id"].value;
            let title = form.elements["title"].value;
            let genre = form.elements["genreSelect"].value;
            let singer = form.elements["singer"].value;
            let user = form.elements["userSelect"].value;
            let isValid = true;

            if (!title) {
                isValid = false;
                $("#spanTitle").text("Field must be set!");
            }            
            if (!singer) {
                isValid = false;
                $("#spanSinger").text("Field must be set!");
            }            

            if (isValid) {
                $("#spanTitle").text("");
                $("#spanSinger").text("");
                let formSong = document.getElementById("form-create-song");                
                formSong.style.display = "none";  
                if (id == 0)
                    CreateSong(title, genre, singer, user);
                else
                    EditSong(id, title, genre, singer, user);
            }
        });  
        // Добавление song
        function CreateSong(songTitle, songGenre, songSinger, songUser) {
            $.ajax({
                url: "https://localhost:7193/api/Songs",
                contentType: "application/json",
                method: "POST",
                data: JSON.stringify({
                    title: songTitle, 
                    genre: songGenre,
                    singer: songSinger,
                    user: songUser
                }),
                success: function (song) {
                    $("table-songs tbody").append(row(song));
                    let form = document.forms["form-create-song"];
                    form.reset();
                    form.elements["Id"].value = 0;
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }
        // Изменение song
        function EditSong(songId, songTitle, songGenre, songSinger, songUser) {
            let request = JSON.stringify({
                id: songId,
                title: songTitle,
                genre: songGenre,
                singer: songSinger,
                user: songUser
            });
            $.ajax({
                url: "https://localhost:7193/api/Songs",
                contentType: "application/json",
                method: "PUT",
                data: request,
                success: function (song) {
                    $("tr[data-rowid='" + song.id + "']").replaceWith(row(song));
                    let form = document.forms["form-create-song"];
                    form.reset();
                    form.elements["Id"].value = 0;
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }
        // нажимаем на ссылку Изменить song
        $("body").on("click", ".editLink", function () {
            let id = $(this).data("id");
            GetSong(id);
        });

        // нажимаем на ссылку Удалить song
        $("body").on("click", ".removeLink", function () {
            let id = $(this).data("id");
            DeleteSong(id);
        });

        function GetSong(id) {
            $.ajax({
                url: 'https://localhost:7193/api/Songs/' + id,
                method: 'GET',
                contentType: "application/json",
                success: function (song) {
                    let form = document.forms["form-create-song"];
                    form.style.display = "block";
                    form.elements["Id"].value = song.id;
                    form.elements["title"].value = song.title;
                    form.elements["genreSelect"].value = song.genre;
                    form.elements["singer"].value = song.singer;
                    form.elements["userSelect"].value = song.user;
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }
        // Удаление song
        function DeleteSong(id) {
            if (!confirm("Do you want to delete this song?"))
                return;
            $.ajax({
                url: "https://localhost:7193/api/Songs/" + id,
                contentType: "application/json",
                method: "DELETE",
                success: function (song) {
                    $("tr[data-rowid='" + song.id + "']").remove();
                },
                error: function (x, y, z) {
                    alert(x.status + '\n' + y + '\n' + z);
                }
            })
        }

        $("#btn-genres").on("click", function () {
            GetGenres();
            let divGenres = document.getElementById("div-genres");
            let divSongs = document.getElementById("div-songs");
            let divUsers = document.getElementById("div-users");
            if (divGenres.style.display !== "block") {
                divGenres.style.display = "block";
                divSongs.style.display = "none";
                divUsers.style.display = "none";
            }
            else {
                divGenres.style.display = "none";
                divSongs.style.display = "block";
            }
        });

        $("#btn-create-genre").on("click", function () {
            let formGenre = document.getElementById("form-create-genre");
            if (formGenre.style.display !== "block")
                formGenre.style.display = "block";
            else
                formGenre.style.display = "none";
        });

        $("#submitGenre").click(function (e) {
            e.preventDefault();
            let form = document.forms["form-create-genre"];
            let id = form.elements["Id"].value;
            let name = form.elements["name"].value;
            let isValid = true;

            if (!name) {
                isValid = false;
                $("#spanGenre").text("Field must be set!");
            }

            if (isValid) {
                $("#spanGenre").text("");
                let formGenre = document.getElementById("form-create-genre");
                formGenre.style.display = "none";
            if (id == 0)
                CreateGenre(name);
            else
                EditGenre(id, name);
            }
        });
        // Добавление жанра
        function CreateGenre(genreName) {
            $.ajax({
                url: "https://localhost:7193/api/Genres",
                contentType: "application/json",
                method: "POST",
                data: JSON.stringify({
                    name: genreName                    
                }),
                success: function (genre) {
                    $("table-genres tbody").append(row1(genre));
                    let form = document.forms["form-create-genre"];
                    form.reset();
                    form.elements["Id"].value = 0;                    
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }
        // Изменение жанра
        function EditGenre(genreId, genreName) {
            let request = JSON.stringify({
                id: genreId,
                name: genreName                
            });
            $.ajax({
                url: "https://localhost:7193/api/Genres",
                contentType: "application/json",
                method: "PUT",
                data: request,
                success: function (genre) {
                    $("tr[data-rowid='" + genre.id + "']").replaceWith(row1(genre));
                    let form = document.forms["form-create-genre"];
                    form.reset();
                    form.elements["Id"].value = 0;
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }

        // нажимаем на ссылку Изменить жанр
        $("body").on("click", ".editGenreLink", function () {
            let id = $(this).data("id");
            GetGenre(id);
        });

        // нажимаем на ссылку Удалить
        $("body").on("click", ".removeGenreLink", function () {
            let id = $(this).data("id");
            DeleteGenre(id);
        });

        function GetGenre(id) {
            $.ajax({
                url: 'https://localhost:7193/api/Genres/' + id,
                method: 'GET',
                contentType: "application/json",
                success: function (genre) {
                    let form = document.forms["form-create-genre"];
                    form.style.display = "block";
                    form.elements["Id"].value = genre.id;
                    form.elements["name"].value = genre.name;
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }

        // Удаление жанра
        function DeleteGenre(id) {
            if (!confirm("Do you want to delete this genre?"))
                return;
            $.ajax({
                url: "https://localhost:7193/api/Genres/" + id,
                contentType: "application/json",
                method: "DELETE",
                success: function (genre) {
                    $("tr[data-rowid='" + genre.id + "']").remove();
                },
                error: function (x, y, z) {
                    alert(x.status + '\n' + y + '\n' + z);
                }
            })
        }      

        // Получение всех жанров
        function GetGenres() {
            $.ajax({
                url: 'https://localhost:7193/api/Genres',
                method: "GET",
                contentType: "application/json",
                success: function (genres) {

                    let rows1 = "";
                    $.each(genres, function (index, genre) {
                        // добавляем полученные элементы в таблицу
                        rows1 += row1(genre);
                    })
                    $("#table-genres tbody").append(rows1);
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }
        // создание строки для таблицы
        let row1 = function (genre) {
            return /*"<tr data-rowid='" + genre.id + "'><td>" + genre.id*/"<tr" + "</td>" +
                "<td>" + genre.name + "</td>" +
                "<td><a class='editGenreLink' data-id='" + genre.id + "'>Edit</a> | " +
                "<a class='removeGenreLink' data-id='" + genre.id + "'>Remove</a></td></tr>";
        };

        $("#resetGenre").click(function (e) {
            e.preventDefault();
            let form = document.forms["form-create-genre"];
            form.reset();
            form.elements["Id"].value = 0;
        });

        $("#btn-users").on("click", function () {
            GetUsers();
            let divSongs = document.getElementById("div-songs");
            let divUsers = document.getElementById("div-users");
            let divGenres = document.getElementById("div-genres");
            if (divUsers.style.display !== "block") {
                divUsers.style.display = "block";
                divSongs.style.display = "none";
                divGenres.style.display = "none";
            }
            else {
                divUsers.style.display = "none";
                divSongs.style.display = "block";
            }
        });

        $("#btn-create-user").on("click", function () {
            let formUser = document.getElementById("form-create-user");
            if (formUser.style.display !== "block")
                formUser.style.display = "block";
            else
                formUser.style.display = "none";
        });

        $("#submitUser").click(function (e) {
            e.preventDefault();
            let form = document.forms["form-create-user"];
            let id = form.elements["Id"].value;            
            let firstName = form.elements["firstName"].value;
            let lastName = form.elements["lastName"].value;
            let login = form.elements["login"].value;
            let email = form.elements["email"].value;
            let isValid = true;

            if (!firstName) {
                isValid = false;
                $("#spanUserFname").text("Field must be set!");
            }
            if (!lastName) {
                isValid = false;
                $("#spanUserLname").text("Field must be set!");
            }
            if (!login) {
                isValid = false;
                $("#spanLogin").text("Field must be set!");
            }           
            const validateEmail = (email) => {
                return String(email)
                    .toLowerCase()
                    .match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)
            }
            if (!validateEmail(email)) {
                isValid = false;
                $("#spanEmail").text("Incorrect email format!");
            }
            
            
            if (isValid) {
                $("#spanUserFname").text("");
                $("#spanUserLname").text("");
                $("#spanLogin").text("");
                $("#spanEmail").text("");
                let formUser = document.getElementById("form-create-user");
                formUser.style.display = "none";
                if (id == 0)
                    CreateUser(firstName, lastName, login, email);
                else
                    EditUser(id, firstName, lastName, login, email);
            }
        });
        
        // Добавление usera
        function CreateUser(userFirstName, userLastName, userLogin, userEmail) {
            $.ajax({
                url: "https://localhost:7193/api/Users",
                contentType: "application/json",
                method: "POST",
                data: JSON.stringify({
                    firstName: userFirstName,
                    lastName: userLastName,
                    login: userLogin,
                    email: userEmail
                }),
                success: function (user) {
                    if (user == "no")
                    {
                        let formUser = document.getElementById("form-create-user");
                        formUser.style.display = "block";
                        alert("Email already in use!");
                    }
                    else { 
                    $("table-users tbody").append(row2(user));
                    let form = document.forms["form-create-user"];
                    form.reset();
                    form.elements["Id"].value = 0;
                    GetUsers();
                    }                    
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }
        
        // Изменение usera
        function EditUser(userId, userFirstName, userLastName, userLogin, userEmail) {
            let request = JSON.stringify({
                id: userId,
                firstName: userFirstName,
                lastName: userLastName,
                login: userLogin,
                email: userEmail
            });
            $.ajax({
                url: "https://localhost:7193/api/Users",
                contentType: "application/json",
                method: "PUT",
                data: request,
                success: function (user) {
                    $("tr[data-rowid='" + user.id + "']").replaceWith(row2(user));
                    let form = document.forms["form-create-user"];
                    form.reset();
                    form.elements["Id"].value = 0;                    
                },
                error: function (x) {
                    alert(x.status);
                }
            })
        }

        // нажимаем на ссылку Изменить user
        $("body").on("click", ".editUserLink", function () {
            let id = $(this).data("id");
            GetUser(id);
        });

        // нажимаем на ссылку Удалить user
        $("body").on("click", ".removeUserLink", function () {
            let id = $(this).data("id");
            DeleteUser(id);
        });

        function GetUser(id) {
            $.ajax({
                url: 'https://localhost:7193/api/Users/' + id,
                method: 'GET',
                contentType: "application/json",
                success: function (user) {
                    let form = document.forms["form-create-user"];
                    form.style.display = "block";
                    form.elements["Id"].value = user.id;
                    form.elements["firstName"].value = user.firstName;
                    form.elements["lastName"].value = user.lastName;
                    form.elements["login"].value = user.login;
                    form.elements["email"].value = user.email;
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }

        // Удаление usera
        function DeleteUser(id) {
            if (!confirm("Do you want to delete this user?"))
                return;
            $.ajax({
                url: "https://localhost:7193/api/Users/" + id,
                contentType: "application/json",
                method: "DELETE",
                success: function (user) {
                    $("tr[data-rowid='" + user.id + "']").remove();                    
                },
                error: function (x, y, z) {
                    alert(x.status + '\n' + y + '\n' + z);
                }
            })
        }
      

        // Получение всех пользователей
        function GetUsers() {
            $.ajax({
                url: 'https://localhost:7193/api/Users',
                method: "GET",
                contentType: "application/json",
                success: function (users) {

                    let rows2 = "";
                    $.each(users, function (index, user) {
                        // добавляем полученные элементы в таблицу
                        rows2 += row2(user);
                    })
                    $("#table-users tbody").append(rows2);
                },
                error: function (x) {
                    alert(x.status);
                }
            });
        }
        // создание строки для таблицы
        let row2 = function (user) {
            return /*"<tr data-rowid='" + user.id + "'><td>" + user.id*/ "<tr>" + "</td>" +
                "<td>" + user.firstName + "</td> <td>" + user.lastName + "</td>" +
                "<td>" + user.login + "</td> <td>" + user.email + "</td>" +
                "<td><a class='editUserLink' data-id='" + user.id + "'>Edit</a> | " +
                "<a class='removeUserLink' data-id='" + user.id + "'>Remove</a></td></tr>";
        };

        $("#resetUser").click(function (e) {
            e.preventDefault();
            let form = document.forms["form-create-user"];
            form.reset();
            form.elements["Id"].value = 0;
        });        

    </script>

</body>
</html >